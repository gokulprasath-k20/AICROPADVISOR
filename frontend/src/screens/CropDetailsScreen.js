import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  ScrollView,
  StyleSheet,
  Dimensions,
} from 'react-native';
import {
  Card,
  Title,
  Paragraph,
  Chip,
  Surface,
  ActivityIndicator,
} from 'react-native-paper';
import { LinearGradient } from 'expo-linear-gradient';
import { Ionicons } from '@expo/vector-icons';
import { theme, gradients } from '../theme/theme';
import axios from 'axios';

const { width } = Dimensions.get('window');

const CropDetailsScreen = ({ route }) => {
  const { crop } = route.params;
  const [loading, setLoading] = useState(true);
  const [cropInfo, setCropInfo] = useState(null);

  useEffect(() => {
    fetchCropDetails();
  }, []);

  const fetchCropDetails = async () => {
    try {
      const response = await axios.get(`http://localhost:8000/crop-info/${crop}`);
      setCropInfo(response.data);
    } catch (error) {
      console.error('Error fetching crop details:', error);
      // Fallback data
      setCropInfo({
        crop: crop,
        season: 'рдЦрд░реАрдл',
        investment_per_ha: 35000,
        expected_revenue_per_ha: 45000,
        expected_profit_per_ha: 10000,
        profit_margin: '30%',
        water_requirement: 'рдЙрдЪреНрдЪ',
        suitable_districts: ['рд░рд╛рдВрдЪреА', 'рдзрдирдмрд╛рдж', 'рдЬрдорд╢реЗрджрдкреБрд░'],
        current_market_price: 25.0
      });
    } finally {
      setLoading(false);
    }
  };

  const getCropEmoji = (cropName) => {
    const cropEmojis = {
      rice: 'ЁЯМ╛',
      wheat: 'ЁЯМ╛',
      maize: 'ЁЯМ╜',
      cotton: 'ЁЯМ┐',
      sugarcane: 'ЁЯОЛ',
      chickpea: 'ЁЯлШ',
      kidney_beans: 'ЁЯлШ',
      banana: 'ЁЯНМ',
      apple: 'ЁЯНО',
      coconut: 'ЁЯее',
    };
    return cropEmojis[cropName] || 'ЁЯМ▒';
  };

  const getCropNameInHindi = (cropName) => {
    const cropNames = {
      rice: 'рдзрд╛рди',
      wheat: 'рдЧреЗрд╣реВрдВ',
      maize: 'рдордХреНрдХрд╛',
      cotton: 'рдХрдкрд╛рд╕',
      sugarcane: 'рдЧрдиреНрдирд╛',
      chickpea: 'рдЪрдирд╛',
      kidney_beans: 'рд░рд╛рдЬрдорд╛',
      banana: 'рдХреЗрд▓рд╛',
      coconut: 'рдирд╛рд░рд┐рдпрд▓',
      apple: 'рд╕реЗрдм',
    };
    return cropNames[cropName] || cropName;
  };

  const getCropDetails = (cropName) => {
    const details = {
      rice: {
        description: 'рдзрд╛рди рднрд╛рд░рдд рдХреА рдореБрдЦреНрдп рдЦрд╛рджреНрдп рдлрд╕рд▓ рд╣реИред рдпрд╣ рдЦрд░реАрдл рдореМрд╕рдо рдореЗрдВ рдЙрдЧрд╛рдИ рдЬрд╛рддреА рд╣реИ рдФрд░ рдЕрдзрд┐рдХ рдкрд╛рдиреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред',
        soilType: 'рдЪрд┐рдХрдиреА рдорд┐рдЯреНрдЯреА, рджреЛрдордЯ рдорд┐рдЯреНрдЯреА',
        climate: 'рдЙрд╖реНрдгрдХрдЯрд┐рдмрдВрдзреАрдп рдФрд░ рдЙрдкреЛрд╖реНрдгрдХрдЯрд┐рдмрдВрдзреАрдп',
        sowingTime: 'рдЬреВрди-рдЬреБрд▓рд╛рдИ',
        harvestTime: 'рдирд╡рдВрдмрд░-рджрд┐рд╕рдВрдмрд░',
        varieties: ['рдмрд╛рд╕рдорддреА', 'рдЖрдИрдЖрд░-64', 'рдкреВрд╕рд╛-1121'],
        diseases: ['рдмреНрд▓рд╛рд╕реНрдЯ', 'рдмреИрдХреНрдЯреАрд░рд┐рдпрд▓ рд▓реАрдл рдмреНрд▓рд╛рдЗрдЯ', 'рд╢реАрде рдмреНрд▓рд╛рдЗрдЯ'],
        fertilizers: ['рдпреВрд░рд┐рдпрд╛', 'рдбреАрдПрдкреА', 'рдкреЛрдЯрд╛рд╢'],
      },
      wheat: {
        description: 'рдЧреЗрд╣реВрдВ рд░рдмреА рдореМрд╕рдо рдХреА рдореБрдЦреНрдп рдлрд╕рд▓ рд╣реИред рдпрд╣ рдардВрдбреЗ рдореМрд╕рдо рдореЗрдВ рдЙрдЧрд╛рдИ рдЬрд╛рддреА рд╣реИ рдФрд░ рдХрдо рдкрд╛рдиреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред',
        soilType: 'рджреЛрдордЯ рдорд┐рдЯреНрдЯреА, рдХрд╛рд▓реА рдорд┐рдЯреНрдЯреА',
        climate: 'рд╢реАрддреЛрд╖реНрдг',
        sowingTime: 'рдирд╡рдВрдмрд░-рджрд┐рд╕рдВрдмрд░',
        harvestTime: 'рдЕрдкреНрд░реИрд▓-рдордИ',
        varieties: ['рдПрдЪрдбреА-2967', 'рдбрдмреНрд▓реНрдпреВрдПрдЪ-147', 'рдкреАрдмреАрдбрдмреНрд▓реНрдпреВ-343'],
        diseases: ['рд░рд╕реНрдЯ', 'рд╕реНрдордЯ', 'рдХрд░реНрдирд▓ рдмрдВрдЯ'],
        fertilizers: ['рдпреВрд░рд┐рдпрд╛', 'рдбреАрдПрдкреА', 'рдПрдордУрдкреА'],
      },
      maize: {
        description: 'рдордХреНрдХрд╛ рдПрдХ рдмрд╣реБрдЙрдкрдпреЛрдЧреА рдлрд╕рд▓ рд╣реИ рдЬреЛ рдЦрд╛рджреНрдп рдФрд░ рдЪрд╛рд░реЗ рджреЛрдиреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрддреА рд╣реИред',
        soilType: 'рджреЛрдордЯ рдорд┐рдЯреНрдЯреА, рдмрд▓реБрдИ рджреЛрдордЯ',
        climate: 'рдЙрд╖реНрдгрдХрдЯрд┐рдмрдВрдзреАрдп рдФрд░ рд╕рдорд╢реАрддреЛрд╖реНрдг',
        sowingTime: 'рдЬреВрди-рдЬреБрд▓рд╛рдИ (рдЦрд░реАрдл), рдлрд░рд╡рд░реА-рдорд╛рд░реНрдЪ (рд░рдмреА)',
        harvestTime: 'рд╕рд┐рддрдВрдмрд░-рдЕрдХреНрдЯреВрдмрд░ (рдЦрд░реАрдл), рдЬреВрди-рдЬреБрд▓рд╛рдИ (рд░рдмреА)',
        varieties: ['рдПрдЪрдПрдо-4', 'рдкреАрдПрдЪрдПрдо-1', 'рдбреАрдХреЗрд╕реА-9081'],
        diseases: ['рдореЗрдбрд┐рд╕ рд▓реАрдл рдмреНрд▓рд╛рдЗрдЯ', 'рдХреЙрдорди рд░рд╕реНрдЯ', 'рд╕реНрдЯреЗрдо рдмреЛрд░рд░'],
        fertilizers: ['рдпреВрд░рд┐рдпрд╛', 'рдбреАрдПрдкреА', 'рдЬрд┐рдВрдХ рд╕рд▓реНрдлреЗрдЯ'],
      }
    };
    return details[cropName] || details.rice;
  };

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={theme.colors.primary} />
        <Text style={styles.loadingText}>рдлрд╕рд▓ рдХреА рдЬрд╛рдирдХрд╛рд░реА рд▓реЛрдб рд╣реЛ рд░рд╣реА рд╣реИ...</Text>
      </View>
    );
  }

  const cropDetails = getCropDetails(crop);

  return (
    <ScrollView style={styles.container} showsVerticalScrollIndicator={false}>
      {/* Header */}
      <LinearGradient colors={gradients.primary} style={styles.header}>
        <Text style={styles.cropEmoji}>{getCropEmoji(crop)}</Text>
        <Text style={styles.cropName}>{getCropNameInHindi(crop)}</Text>
        <Text style={styles.cropNameEng}>({crop})</Text>
      </LinearGradient>

      {/* Basic Info */}
      <View style={styles.section}>
        <Card style={styles.infoCard}>
          <Card.Content>
            <Title style={styles.cardTitle}>рдореВрд▓рднреВрдд рдЬрд╛рдирдХрд╛рд░реА</Title>
            <Paragraph style={styles.description}>
              {cropDetails.description}
            </Paragraph>
          </Card.Content>
        </Card>
      </View>

      {/* Financial Overview */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рд╡рд┐рддреНрддреАрдп рд╡рд┐рд╡рд░рдг</Title>
        <View style={styles.financialGrid}>
          <Surface style={styles.financialCard}>
            <Ionicons name="trending-down" size={24} color="#F44336" />
            <Text style={styles.financialLabel}>рдирд┐рд╡реЗрд╢</Text>
            <Text style={styles.financialValue}>
              тВ╣{cropInfo?.investment_per_ha?.toLocaleString()}
            </Text>
            <Text style={styles.financialUnit}>рдкреНрд░рддрд┐ рд╣реЗрдХреНрдЯреЗрдпрд░</Text>
          </Surface>
          
          <Surface style={styles.financialCard}>
            <Ionicons name="trending-up" size={24} color="#4CAF50" />
            <Text style={styles.financialLabel}>рдЖрдп</Text>
            <Text style={styles.financialValue}>
              тВ╣{cropInfo?.expected_revenue_per_ha?.toLocaleString()}
            </Text>
            <Text style={styles.financialUnit}>рдкреНрд░рддрд┐ рд╣реЗрдХреНрдЯреЗрдпрд░</Text>
          </Surface>
          
          <Surface style={styles.financialCard}>
            <Ionicons name="cash" size={24} color="#2196F3" />
            <Text style={styles.financialLabel}>рд▓рд╛рдн</Text>
            <Text style={styles.financialValue}>
              тВ╣{cropInfo?.expected_profit_per_ha?.toLocaleString()}
            </Text>
            <Text style={styles.financialUnit}>рдкреНрд░рддрд┐ рд╣реЗрдХреНрдЯреЗрдпрд░</Text>
          </Surface>
          
          <Surface style={styles.financialCard}>
            <Ionicons name="pie-chart" size={24} color="#FF9800" />
            <Text style={styles.financialLabel}>рд▓рд╛рдн рдорд╛рд░реНрдЬрд┐рди</Text>
            <Text style={styles.financialValue}>
              {cropInfo?.profit_margin}
            </Text>
            <Text style={styles.financialUnit}>рдХреБрд▓ рдЖрдп рдХрд╛</Text>
          </Surface>
        </View>
      </View>

      {/* Growing Conditions */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рдЙрдЧрд╛рдиреЗ рдХреА рд╢рд░реНрддреЗрдВ</Title>
        <Card style={styles.conditionsCard}>
          <Card.Content>
            <View style={styles.conditionItem}>
              <Ionicons name="earth" size={20} color="#8D6E63" />
              <Text style={styles.conditionLabel}>рдорд┐рдЯреНрдЯреА:</Text>
              <Text style={styles.conditionValue}>{cropDetails.soilType}</Text>
            </View>
            
            <View style={styles.conditionItem}>
              <Ionicons name="thermometer" size={20} color="#FF5722" />
              <Text style={styles.conditionLabel}>рдЬрд▓рд╡рд╛рдпреБ:</Text>
              <Text style={styles.conditionValue}>{cropDetails.climate}</Text>
            </View>
            
            <View style={styles.conditionItem}>
              <Ionicons name="water" size={20} color="#2196F3" />
              <Text style={styles.conditionLabel}>рдкрд╛рдиреА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛:</Text>
              <Text style={styles.conditionValue}>{cropInfo?.water_requirement}</Text>
            </View>
            
            <View style={styles.conditionItem}>
              <Ionicons name="calendar" size={20} color="#4CAF50" />
              <Text style={styles.conditionLabel}>рдореМрд╕рдо:</Text>
              <Text style={styles.conditionValue}>{cropInfo?.season}</Text>
            </View>
          </Card.Content>
        </Card>
      </View>

      {/* Timing */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рд╕рдордп рд╕рд╛рд░рдгреА</Title>
        <View style={styles.timingGrid}>
          <Surface style={styles.timingCard}>
            <Ionicons name="play" size={24} color="#4CAF50" />
            <Text style={styles.timingLabel}>рдмреБрдЖрдИ рдХрд╛ рд╕рдордп</Text>
            <Text style={styles.timingValue}>{cropDetails.sowingTime}</Text>
          </Surface>
          
          <Surface style={styles.timingCard}>
            <Ionicons name="checkmark" size={24} color="#FF9800" />
            <Text style={styles.timingLabel}>рдХрдЯрд╛рдИ рдХрд╛ рд╕рдордп</Text>
            <Text style={styles.timingValue}>{cropDetails.harvestTime}</Text>
          </Surface>
        </View>
      </View>

      {/* Suitable Districts */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рдЙрдкрдпреБрдХреНрдд рдЬрд┐рд▓реЗ</Title>
        <Card style={styles.districtsCard}>
          <Card.Content>
            <View style={styles.chipsContainer}>
              {cropInfo?.suitable_districts?.map((district, index) => (
                <Chip
                  key={index}
                  style={styles.districtChip}
                  textStyle={styles.chipText}
                >
                  {district}
                </Chip>
              ))}
            </View>
          </Card.Content>
        </Card>
      </View>

      {/* Varieties */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рдореБрдЦреНрдп рдХрд┐рд╕реНрдореЗрдВ</Title>
        <Card style={styles.varietiesCard}>
          <Card.Content>
            <View style={styles.chipsContainer}>
              {cropDetails.varieties.map((variety, index) => (
                <Chip
                  key={index}
                  style={[styles.varietyChip, { backgroundColor: theme.colors.primary + '20' }]}
                  textStyle={[styles.chipText, { color: theme.colors.primary }]}
                >
                  {variety}
                </Chip>
              ))}
            </View>
          </Card.Content>
        </Card>
      </View>

      {/* Common Diseases */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рд╕рд╛рдорд╛рдиреНрдп рд░реЛрдЧ</Title>
        <Card style={styles.diseasesCard}>
          <Card.Content>
            {cropDetails.diseases.map((disease, index) => (
              <View key={index} style={styles.diseaseItem}>
                <Ionicons name="warning" size={16} color="#F44336" />
                <Text style={styles.diseaseText}>{disease}</Text>
              </View>
            ))}
          </Card.Content>
        </Card>
      </View>

      {/* Fertilizers */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рдЕрдиреБрд╢рдВрд╕рд┐рдд рдЙрд░реНрд╡рд░рдХ</Title>
        <Card style={styles.fertilizersCard}>
          <Card.Content>
            <View style={styles.chipsContainer}>
              {cropDetails.fertilizers.map((fertilizer, index) => (
                <Chip
                  key={index}
                  style={[styles.fertilizerChip, { backgroundColor: '#4CAF50' + '20' }]}
                  textStyle={[styles.chipText, { color: '#4CAF50' }]}
                >
                  {fertilizer}
                </Chip>
              ))}
            </View>
          </Card.Content>
        </Card>
      </View>

      {/* Current Market Price */}
      <View style={styles.section}>
        <Title style={styles.sectionTitle}>рд╡рд░реНрддрдорд╛рди рдмрд╛рдЬрд╛рд░ рднрд╛рд╡</Title>
        <Card style={styles.priceCard}>
          <LinearGradient colors={['#4CAF50', '#66BB6A']} style={styles.priceHeader}>
            <Ionicons name="pricetag" size={32} color="#fff" />
            <Text style={styles.currentPrice}>
              тВ╣{cropInfo?.current_market_price} рдкреНрд░рддрд┐ рдХрд┐рд▓реЛ
            </Text>
          </LinearGradient>
          <Card.Content>
            <Text style={styles.priceNote}>
              * рдпрд╣ рднрд╛рд╡ рдЭрд╛рд░рдЦрдВрдб рдХреЗ рдореБрдЦреНрдп рдмрд╛рдЬрд╛рд░реЛрдВ рдХрд╛ рдФрд╕рдд рд╣реИ
            </Text>
          </Card.Content>
        </Card>
      </View>

      <View style={{ height: 20 }} />
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: theme.colors.background,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: theme.colors.background,
  },
  loadingText: {
    marginTop: 16,
    fontSize: 16,
    color: theme.colors.text,
  },
  header: {
    padding: 30,
    alignItems: 'center',
    borderBottomLeftRadius: 25,
    borderBottomRightRadius: 25,
  },
  cropEmoji: {
    fontSize: 64,
    marginBottom: 15,
  },
  cropName: {
    fontSize: 28,
    fontWeight: 'bold',
    color: '#fff',
    marginBottom: 5,
  },
  cropNameEng: {
    fontSize: 16,
    color: '#fff',
    opacity: 0.9,
    textTransform: 'capitalize',
  },
  section: {
    padding: 20,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: theme.colors.text,
    marginBottom: 15,
  },
  infoCard: {
    borderRadius: 15,
    elevation: 2,
  },
  cardTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: theme.colors.text,
    marginBottom: 10,
  },
  description: {
    fontSize: 16,
    color: theme.colors.text,
    lineHeight: 24,
  },
  financialGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
  },
  financialCard: {
    width: (width - 60) / 2,
    padding: 15,
    borderRadius: 10,
    elevation: 2,
    alignItems: 'center',
    marginBottom: 15,
  },
  financialLabel: {
    fontSize: 14,
    color: theme.colors.text,
    marginTop: 8,
  },
  financialValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: theme.colors.text,
    marginTop: 4,
  },
  financialUnit: {
    fontSize: 12,
    color: theme.colors.text,
    opacity: 0.7,
    marginTop: 2,
  },
  conditionsCard: {
    borderRadius: 15,
    elevation: 2,
  },
  conditionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 15,
  },
  conditionLabel: {
    fontSize: 16,
    color: theme.colors.text,
    marginLeft: 10,
    flex: 1,
  },
  conditionValue: {
    fontSize: 16,
    color: theme.colors.text,
    flex: 2,
    textAlign: 'right',
  },
  timingGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  timingCard: {
    flex: 1,
    padding: 20,
    borderRadius: 10,
    elevation: 2,
    alignItems: 'center',
    marginHorizontal: 5,
  },
  timingLabel: {
    fontSize: 14,
    color: theme.colors.text,
    marginTop: 10,
    textAlign: 'center',
  },
  timingValue: {
    fontSize: 16,
    fontWeight: 'bold',
    color: theme.colors.text,
    marginTop: 5,
    textAlign: 'center',
  },
  districtsCard: {
    borderRadius: 15,
    elevation: 2,
  },
  chipsContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
  },
  districtChip: {
    marginRight: 10,
    marginBottom: 8,
    backgroundColor: theme.colors.accent + '20',
  },
  chipText: {
    color: theme.colors.text,
  },
  varietiesCard: {
    borderRadius: 15,
    elevation: 2,
  },
  varietyChip: {
    marginRight: 10,
    marginBottom: 8,
  },
  diseasesCard: {
    borderRadius: 15,
    elevation: 2,
  },
  diseaseItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10,
  },
  diseaseText: {
    marginLeft: 10,
    fontSize: 16,
    color: theme.colors.text,
  },
  fertilizersCard: {
    borderRadius: 15,
    elevation: 2,
  },
  fertilizerChip: {
    marginRight: 10,
    marginBottom: 8,
  },
  priceCard: {
    borderRadius: 15,
    elevation: 3,
    overflow: 'hidden',
  },
  priceHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    padding: 20,
  },
  currentPrice: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#fff',
    marginLeft: 15,
  },
  priceNote: {
    fontSize: 12,
    color: theme.colors.text,
    opacity: 0.7,
    fontStyle: 'italic',
    textAlign: 'center',
    marginTop: 10,
  },
});

export default CropDetailsScreen;
